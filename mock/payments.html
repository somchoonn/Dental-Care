<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô | SmileCare</title>
  <link rel="stylesheet" href="styles2.css" />
  <style>
    /* ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏ô‡∏µ‡πä‡∏¢‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px
    }

    .toolbar .left,
    .toolbar .right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #e6e6fb;
      background: #fbfbff;
      cursor: pointer;
      font-weight: 600
    }

    .pill[data-active="true"] {
      background: #efe9ff;
      border-color: #d8cfff;
      color: #5936ff
    }

    .search {
      position: relative
    }

    .search input {
      padding-left: 34px
    }

    .search:before {
      content: "üîé";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: .7
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 12px
    }

    @media (max-width:780px) {
      .summary {
        grid-template-columns: 1fr
      }
    }

    .card-mini {
      background: #fff;
      border: 1px solid #eef0ff;
      border-radius: 14px;
      padding: 12px 14px
    }

    .k {
      color: #5b6b8a;
      font-size: 12px;
      margin-bottom: 2px
    }

    .v {
      font-size: 20px;
      font-weight: 800
    }

    .table th {
      user-select: none;
      cursor: pointer
    }

    .table th .sort {
      opacity: .5;
      font-size: 12px;
      margin-left: 6px
    }

    .status-wrap {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .actions .primary {
      width: auto
    }

    .btn {
      border: 1px solid #e6e6fb;
      background: #fff;
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 600;
      cursor: pointer
    }

    .btn:hover {
      background: #f6f6ff
    }

    .btn-danger {
      border-color: #ffd7d7;
      color: #a32020
    }

    .note {
      color: #7b86a8;
      font-size: 12px
    }
  </style>
</head>

<body>
  <main>
    <section class="wrap">
      <div class="brand">
        <div class="logo">
          <img src="logo.png" alt="Dentalcare Logo">
        </div>
        <div>
          <h1>DENTALCARE</h1>
          <p class="sub">PAYMENT</p>
        </div>
      </div>


      <!-- ‡πÅ‡∏ñ‡∏ö‡∏™‡∏£‡∏∏‡∏õ -->
      <div class="summary">
        <div class="card-mini">
          <div class="k">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div id="sum-count" class="v">‚Äî</div>
        </div>
        <div class="card-mini">
          <div class="k">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞)</div>
          <div id="sum-unpaid" class="v">‚Äî</div>
        </div>
        <div class="card-mini">
          <div class="k">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>
          <div id="sum-paid" class="v">‚Äî</div>
        </div>
      </div>

      <!-- ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ -->
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <button class="pill" data-filter="all" data-active="true" onclick="setFilter('all',this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button class="pill" data-filter="unpaid" data-active="false"
              onclick="setFilter('unpaid',this)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞</button>
            <button class="pill" data-filter="paid" data-active="false"
              onclick="setFilter('paid',this)">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
            <div class="search">
              <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏¥‡∏•" oninput="render()" />
            </div>
          </div>
          <div class="right">
            <select id="sort" class="btn" onchange="render()">
              <option value="date_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
              <option value="date_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤</option>
              <option value="amount_desc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</option>
              <option value="amount_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡∏¢‡∏≠‡∏î‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å</option>
            </select>
            <button class="btn" onclick="exportCSV()">Export Excel</button>
          </div>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏• -->
        <div id="bills"></div>
        <div class="note">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="ts"></span></div>
      </div>

      <div class="card">
        <a class="link" href="index.html">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</a>
      </div>
    </section>
  </main>

  <script>
    // ‚Äî‚Äî‚Äî Mock data ‚Äî‚Äî‚Äî
    const patients = {
      PT001: { id: 'PT001', titleName: '‡∏ô‡∏≤‡∏¢', firstName: '‡∏ä‡∏ô‡∏Å‡∏ä‡∏ô‡∏°‡πå', lastName: '‡πÅ‡∏ú‡πà‡∏ô‡∏Ñ‡∏≥' },
      PT002: { id: 'PT002', titleName: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', firstName: '‡∏û‡∏±‡∏ó‡∏ò‡πå‡∏ò‡∏µ‡∏£‡∏≤', lastName: '‡∏ö‡∏∏‡∏ï‡∏£‡∏ò‡∏£‡∏£‡∏°' },
    };

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà billDate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á/‡πÅ‡∏™‡∏î‡∏á
    let bills = [
      { id: 'PM001', billDate: '2025-08-10', patientId: 'PT001', status: 'unpaid', items: [{ name: '‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô', qty: 1, price: 1200 }, { name: '‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', qty: 1, price: 100 }] },
      { id: 'PM002', billDate: '2025-08-09', patientId: 'PT002', status: 'paid', items: [{ name: '‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô', qty: 1, price: 900 }, { name: '‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', qty: 1, price: 100 }] },
    ];

    let currentFilter = 'all';

    function money(n) { return n.toLocaleString(); }
    function fullName(p) { return `${p.titleName}${p.firstName} ${p.lastName}`; }

    function statusBadge(status) {
      const txt = status === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞';
      const color = status === 'paid'
        ? 'background:#eafff2;border:1px solid #c7f9dd;color:#0a6b34;'
        : 'background:#fff6f6;border:1px solid #ffd7d7;color:#a32020;';
      return `<span class="badge" style="${color} padding:4px 8px;border-radius:999px;">${txt}</span>`;
    }

    function billTotal(b) { return b.items.reduce((s, it) => s + it.qty * it.price, 0); }

    function card(b) {
      const pt = patients[b.patientId];
      const total = billTotal(b);
      const rows = b.items.map(it => `
    <tr>
      <td>${it.name}</td>
      <td style="text-align:right">${it.qty}</td>
      <td style="text-align:right">${money(it.price)}</td>
      <td style="text-align:right">${money(it.qty * it.price)}</td>
    </tr>`).join('');

      const payBtn = b.status === 'paid'
        ? `<button class="primary" type="button" disabled style="opacity:.6;cursor:not-allowed;">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>`
        : `<button class="primary" type="button" onclick="markPaid('${b.id}')">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>`;

      const undoBtn = b.status === 'paid'
        ? `<button class="btn btn-danger" type="button" onclick="markUnpaid('${b.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>`
        : '';

      return `
    <div style="border:1px solid #eef0ff;border-radius:14px;padding:14px;margin-bottom:14px;background:#fcfcff;">
      <div class="row between" style="margin-bottom:6px;align-items:flex-start;">
        <div>
          <div><strong>${fullName(pt)}</strong> ¬∑ <span style="color:#667">Patient ID: ${pt.id}</span></div>
          <div class="note">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•: ${b.id} ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•: ${b.billDate}</div>
        </div>
        <div class="status-wrap">
          ${statusBadge(b.status)}
          <strong>‡∏£‡∏ß‡∏°: ${money(total)} ‡∏ö‡∏≤‡∏ó</strong>
        </div>
      </div>

      <div style="overflow:auto;">
        <table class="table" style="border-spacing:0">
          <thead>
            <tr>
              <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
              <th style="text-align:right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th style="text-align:right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th style="text-align:right">‡∏£‡∏ß‡∏°</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>

      <div class="actions" style="margin-top:10px;">
        <a class="link" href="#" onclick="window.print();return false;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a>
        <div style="display:flex;gap:8px;align-items:center">
          ${undoBtn}
          ${payBtn}
        </div>
      </div>
    </div>`;
    }

    function setFilter(f, btn) {
      currentFilter = f;
      document.querySelectorAll('.pill').forEach(p => p.dataset.active = (p === btn));
      render();
    }

    function filteredSorted() {
      // filter
      const q = (document.getElementById('q').value || '').toLowerCase();
      let data = bills.filter(b => {
        const pt = patients[b.patientId];
        const hay = `${b.id} ${fullName(pt)} ${b.items.map(i => i.name).join(' ')}`.toLowerCase();
        const passText = !q || hay.includes(q);
        const passFilter = currentFilter === 'all' ? true : b.status === currentFilter;
        return passText && passFilter;
      });
      // sort
      const sort = document.getElementById('sort').value;
      data.sort((a, b) => {
        if (sort === 'date_desc') return (a.billDate > b.billDate ? -1 : 1);
        if (sort === 'date_asc') return (a.billDate < b.billDate ? -1 : 1);
        if (sort === 'name_asc') return fullName(patients[a.patientId]).localeCompare(fullName(patients[b.patientId]));
        if (sort === 'amount_desc') return billTotal(b) - billTotal(a);
        if (sort === 'amount_asc') return billTotal(a) - billTotal(b);
        return 0;
      });
      return data;
    }

    function render() {
      const data = filteredSorted();
      document.getElementById('bills').innerHTML = data.map(card).join('');
      // summary
      const totalAll = bills.reduce((s, b) => s + billTotal(b), 0);
      const totalUnpay = bills.filter(b => b.status === 'unpaid').reduce((s, b) => s + billTotal(b), 0);
      const totalPaid = totalAll - totalUnpay;
      document.getElementById('sum-count').textContent = bills.length.toLocaleString();
      document.getElementById('sum-unpaid').textContent = totalUnpay.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('sum-paid').textContent = totalPaid.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('ts').textContent = new Date().toLocaleString();
    }

    function markPaid(id) {
      const b = bills.find(x => x.id === id);
      if (!b) return;
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${id} ?`)) return;
      b.status = 'paid';
      render();
      // alert('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

    function markUnpaid(id) {
      const b = bills.find(x => x.id === id);
      if (!b) return;
      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${id} ?`)) return;
      b.status = 'unpaid';
      render();
    }

    function exportCSV() {
      const data = filteredSorted();
      const rows = [
        ['BillID', 'BillDate', 'PatientID', 'PatientName', 'Status', 'Item', 'Qty', 'UnitPrice', 'Amount', 'BillTotal']
      ];
      data.forEach(b => {
        const pt = patients[b.patientId];
        const name = fullName(pt);
        const billT = billTotal(b);
        b.items.forEach(it => {
          rows.push([b.id, b.billDate, pt.id, name, b.status, it.name, it.qty, it.price, it.qty * it.price, billT]);
        });
      });
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `payments_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    render();
  </script>
</body>

</html>